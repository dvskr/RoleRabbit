generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SubscriptionTier {
  FREE
  PRO
  PREMIUM
}

enum TailorMode {
  PARTIAL
  FULL
}

enum AIAction {
  GENERATE_CONTENT
  TAILOR_PARTIAL
  TAILOR_FULL
  APPLY_RECOMMENDATIONS
  COVER_LETTER
  PORTFOLIO
  JD_ANALYSIS
  ATS_SCORE
}

enum GeneratedDocType {
  COVER_LETTER
  PORTFOLIO_SECTION
  OTHER
}

enum AIAgentTaskType {
  RESUME_GENERATION
  COVER_LETTER_GENERATION
  JOB_APPLICATION
  COMPANY_RESEARCH
  INTERVIEW_PREP
  BULK_PROCESSING
  JOB_TRACKER_UPDATE
  COLD_EMAIL
}

enum AIAgentTaskStatus {
  QUEUED
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
}

enum JobBoardPlatform {
  LINKEDIN
  INDEED
  GLASSDOOR
  ZIPRECRUITER
  MONSTER
  DICE
  OTHER
}

enum ApplicationStatus {
  DRAFT
  SUBMITTED
  VIEWED
  IN_REVIEW
  INTERVIEWING
  OFFERED
  REJECTED
  ACCEPTED
  WITHDRAWN
}

model Certification {
  id        String @id @default(cuid())
  profileId String

  name          String
  issuer        String?
  date          String?
  expiryDate    String?
  credentialId  String?
  credentialUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([issuer])
  @@map("certifications")
}

model CredentialReminder {
  id           String   @id @default(cuid())
  credentialId String
  reminderDate DateTime
  isSent       Boolean  @default(false)
  priority     String   @default("medium") // low, medium, high

  createdAt DateTime @default(now())

  credential Credential @relation(fields: [credentialId], references: [id], onDelete: Cascade)

  @@index([credentialId])
  @@index([reminderDate])
  @@index([isSent])
  @@map("credential_reminders")
}

model Credential {
  id     String  @id @default(cuid())
  userId String
  fileId String? // Associated file if any

  credentialType  String // certification, license, visa, degree, badge
  name            String
  issuer          String
  issuedDate      String
  expirationDate  String?
  credentialId    String? // External credential ID
  verificationUrl String?
  qrCode          String? // Base64 QR code

  verificationStatus String @default("pending") // pending, verified, expired, revoked

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User                 @relation("Credentials", fields: [userId], references: [id], onDelete: Cascade)
  file      StorageFile?         @relation(fields: [fileId], references: [id], onDelete: SetNull)
  reminders CredentialReminder[]

  @@index([userId])
  @@index([fileId])
  @@index([credentialType])
  @@index([verificationStatus])
  @@map("credentials")
}

model Education {
  id        String @id @default(cuid())
  profileId String

  institution String
  degree      String?
  field       String?
  startDate   String?
  endDate     String?
  gpa         String?
  honors      String?
  location    String?
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([institution])
  @@map("education")
}

model Language {
  id        String @id @default(cuid())
  profileId String

  name        String
  proficiency String? // Native, Fluent, Conversational, Basic, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("languages")
}

model FileAccessLog {
  id        String  @id @default(cuid())
  fileId    String
  userId    String
  action    String // view, download, share, edit, delete
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  file StorageFile @relation(fields: [fileId], references: [id], onDelete: Cascade)
  user User        @relation("FileAccessLogs", fields: [userId], references: [id], onDelete: Cascade)

  @@index([fileId])
  @@index([userId])
  @@index([createdAt])
  @@map("file_access_logs")
}

model FileComment {
  id       String  @id @default(cuid())
  fileId   String
  userId   String
  content  String
  parentId String? // For threaded comments

  isResolved Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  file    StorageFile   @relation(fields: [fileId], references: [id], onDelete: Cascade)
  user    User          @relation("FileComments", fields: [userId], references: [id], onDelete: Cascade)
  parent  FileComment?  @relation("CommentThread", fields: [parentId], references: [id], onDelete: Cascade)
  replies FileComment[] @relation("CommentThread")

  @@index([fileId])
  @@index([parentId])
  @@map("file_comments")
}

model FileShare {
  id         String @id @default(cuid())
  fileId     String
  userId     String // User who shared
  sharedWith String // User ID of recipient

  permission String    @default("view") // view, comment, edit, admin
  expiresAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  file      StorageFile @relation(fields: [fileId], references: [id], onDelete: Cascade)
  sharer    User        @relation("FileShares", fields: [userId], references: [id], onDelete: Cascade)
  recipient User        @relation("SharedWithMe", fields: [sharedWith], references: [id], onDelete: Cascade)

  @@unique([fileId, sharedWith])
  @@index([fileId])
  @@index([sharedWith])
  @@map("file_shares")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime
  used      Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model Project {
  id        String @id @default(cuid())
  profileId String

  title        String
  description  String?
  technologies String? // JSON array or comma-separated
  date         String?
  link         String?
  github       String?
  media        String? // JSON array of media URLs

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("projects")
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  device       String? // Device info (desktop, mobile, tablet)
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())
  lastActivity DateTime @default(now())
  expiresAt    DateTime
  isActive     Boolean  @default(true)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
  @@index([expiresAt])
  @@map("sessions")
}

model ShareLink {
  id     String @id @default(cuid())
  fileId String
  userId String

  token         String    @unique
  password      String? // Hashed password if protected
  permission    String    @default("view") // view, comment, edit, admin
  expiresAt     DateTime?
  maxDownloads  Int?
  downloadCount Int       @default(0)

  createdAt DateTime @default(now())

  file StorageFile @relation(fields: [fileId], references: [id], onDelete: Cascade)
  user User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([fileId])
  @@map("share_links")
}

model Skill {
  id       String  @id @default(cuid())
  name     String  @unique // Normalized skill name
  category String? // e.g., "Technical", "Soft", "Language"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userSkills UserSkill[]

  @@index([name])
  @@index([category])
  @@map("skills")
}

model StorageFile {
  id     String @id @default(cuid())
  userId String

  // File Information
  name        String // Display name
  fileName    String // Original filename
  type        String // resume, template, backup, document, etc.
  contentType String // MIME type (e.g., application/pdf)
  size        BigInt // File size in bytes
  storagePath String // Path in Supabase Storage or local filesystem
  publicUrl   String? // Public URL if bucket is public

  // Metadata
  description String? // File description
  isPublic    Boolean @default(false)
  isStarred   Boolean @default(false)
  isArchived  Boolean @default(false)
  folderId    String? // Parent folder ID

  // Soft delete
  deletedAt DateTime?

  // File metrics
  downloadCount Int @default(0)
  viewCount     Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user                     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  folder                   StorageFolder?   @relation(fields: [folderId], references: [id], onDelete: SetNull)
  shares                   FileShare[]
  shareLinks               ShareLink[]
  comments                 FileComment[]
  accessLogs               FileAccessLog[]
  credentials              Credential[]
  applicationsAsResume     JobApplication[] @relation("ApplicationResume")
  applicationsAsCoverLetter JobApplication[] @relation("ApplicationCoverLetter")

  @@index([userId])
  @@index([folderId])
  @@index([type])
  @@index([deletedAt])
  @@index([isStarred])
  @@index([isArchived])
  @@map("storage_files")
}

model StorageFolder {
  id     String @id @default(cuid())
  userId String

  name     String
  parentId String? // For nested folders
  color    String? // Optional folder color

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent   StorageFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children StorageFolder[] @relation("FolderHierarchy")
  files    StorageFile[]

  @@index([userId])
  @@index([parentId])
  @@index([deletedAt])
  @@map("storage_folders")
}

model StorageQuota {
  id         String @id @default(cuid())
  userId     String @unique
  usedBytes  BigInt @default(0)
  limitBytes BigInt @default(5368709120) // 5GB default

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("storage_quotas")
}

model UserProfile {
  id     String @id @default(cuid())
  userId String @unique

  // Profile Tab - Basic Information
  firstName      String?
  lastName       String?
  phone          String?
  personalEmail  String? // Personal/contact email (separate from login email)
  location       String?
  profilePicture String?

  // Profile Tab - Social Links
  linkedin  String?
  github    String?
  portfolio String? // Portfolio URL
  website   String?

  // Professional Tab
  professionalBio String? @map("professionalBio")

  // Profile Analytics & Metrics
  profileCompleteness Int @default(0) // Percentage (0-100)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations - Only keep what's needed for the tabs
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  workExperiences WorkExperience[] // Professional Tab
  projects        Project[] // Professional Tab - Separate section
  education       Education[] // Skills & Expertise Tab
  certifications  Certification[] // Skills & Expertise Tab
  languages       Language[] // Skills & Expertise Tab
  userSkills      UserSkill[] // Skills & Expertise Tab

  @@index([userId])
  @@map("user_profiles")
}

model UserSkill {
  id        String @id @default(cuid())
  profileId String
  skillId   String

  yearsOfExperience Int?
  verified          Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  skill   Skill       @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([profileId, skillId])
  @@index([profileId])
  @@index([skillId])
  @@map("user_skills")
}

model User {
  id         String  @id @default(cuid())
  email      String  @unique
  name       String
  password   String? // Optional for OAuth users
  provider   String  @default("local") // local, google, github
  providerId String? @unique

  // Two-Factor Authentication
  twoFactorEnabled     Boolean @default(false)
  twoFactorSecret      String?
  twoFactorBackupCodes String? // JSON array of backup codes

  // Preferences (frequently accessed)
  emailNotifications Boolean @default(true)

  // Subscription & Usage Tracking
  subscriptionTier          SubscriptionTier @default(FREE)
  subscriptionEndsAt        DateTime?
  activeBaseResumeId        String?          @unique
  resumeAiUsageCount        Int              @default(0)
  resumeAiUsageResetAt      DateTime?
  coverLetterAiUsageCount   Int              @default(0)
  coverLetterAiUsageResetAt DateTime?
  portfolioPublishesCount   Int              @default(0)
  portfolioPublishesResetAt DateTime?
  aiAgentsRunsCount         Int              @default(0)
  aiAgentsRunsResetAt       DateTime?
  workflowsRunsCount        Int              @default(0)
  workflowsRunsResetAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  profile             UserProfile?
  refreshTokens       RefreshToken[]
  sessions            Session[]
  passwordResetTokens PasswordResetToken[]
  storageFiles        StorageFile[]
  storageFolders      StorageFolder[]
  fileShares          FileShare[]          @relation("FileShares")
  sharedFiles         FileShare[]          @relation("SharedWithMe")
  shareLinks          ShareLink[]
  fileComments        FileComment[]        @relation("FileComments")
  fileAccessLogs      FileAccessLog[]      @relation("FileAccessLogs")
  credentials         Credential[]         @relation("Credentials")
  storageQuota        StorageQuota?
  resumes             Resume[]             @relation("Resumes")
  baseResumes         BaseResume[]         @relation("UserBaseResumes")
  tailoredVersions    TailoredVersion[]
  generatedDocuments  GeneratedDocument[]
  aiRequests          AIRequestLog[]
  aiDrafts            AIDraft[]
  resumeCacheEntries  ResumeCache[]
  activeBaseResume    BaseResume?          @relation("ActiveBaseResume", fields: [activeBaseResumeId], references: [id], onDelete: SetNull)
  aiAgentTasks        AIAgentTask[]        @relation("AIAgentTasks")
  aiAgentSettings     AIAgentSettings?     @relation("AIAgentSettings")
  aiAgentHistory      AIAgentHistory[]     @relation("AIAgentHistory")
  aiAgentConversations AIAgentConversation[] @relation("AIAgentConversations")
  aiAgentMetrics      AIAgentMetrics[]     @relation("AIAgentMetrics")
  jobBoardCredentials JobBoardCredential[] @relation("JobBoardCredentials")
  jobApplications     JobApplication[]     @relation("JobApplications")

  @@index([email])
  @@index([provider, providerId])
  @@map("users")
}

model WorkExperience {
  id        String @id @default(cuid())
  profileId String

  company      String
  role         String
  location     String?
  startDate    String
  endDate      String?
  isCurrent    Boolean  @default(false)
  description  String?
  technologies String[] @default([]) // Technologies/tools used in this role
  projectType  String?  @default("Full-time") // Full-time, Part-time, Contract, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([company])
  @@map("work_experiences")
}

model BaseResume {
  id                String    @id @default(cuid())
  userId            String
  slotNumber        Int
  name              String
  isActive          Boolean   @default(false)
  data              Json
  formatting        Json?     @default("{}")
  metadata          Json?     @default("{}")
  lastAIAccessedAt  DateTime?
  parsingConfidence Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user               User                @relation("UserBaseResumes", fields: [userId], references: [id], onDelete: Cascade)
  activeUser         User?               @relation("ActiveBaseResume")
  tailoredVersions   TailoredVersion[]
  generatedDocuments GeneratedDocument[]
  resumeCaches       ResumeCache[]
  aiRequests         AIRequestLog[]
  aiDrafts           AIDraft[]

  @@unique([userId, slotNumber])
  @@index([userId, isActive])
  @@map("base_resumes")
}

model TailoredVersion {
  id                 String     @id @default(cuid())
  baseResumeId       String
  userId             String
  jobTitle           String?
  company            String?
  jobDescriptionHash String?
  mode               TailorMode @default(PARTIAL)
  tone               String?
  data               Json
  diff               Json?
  atsScoreBefore     Int?
  atsScoreAfter      Int?
  isPromoted         Boolean    @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  baseResume         BaseResume          @relation(fields: [baseResumeId], references: [id], onDelete: Cascade)
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  generatedDocuments GeneratedDocument[]
  aiRequests         AIRequestLog[]

  @@index([baseResumeId])
  @@index([userId])
  @@index([jobDescriptionHash])
  @@map("tailored_versions")
}

model ResumeCache {
  id           String    @id @default(cuid())
  userId       String
  baseResumeId String?
  fileHash     String    @unique
  method       String
  data         Json
  confidence   Float?
  hitCount     Int       @default(0)
  createdAt    DateTime  @default(now())
  lastUsedAt   DateTime  @default(now())
  expiresAt    DateTime?

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  baseResume BaseResume? @relation(fields: [baseResumeId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@map("resume_cache")
}

model AIRequestLog {
  id                String   @id @default(cuid())
  userId            String
  baseResumeId      String?
  tailoredVersionId String?
  action            AIAction
  provider          String?
  model             String?
  tokensUsed        Int?
  costUsd           Decimal? @db.Decimal(12, 4)
  status            String   @default("success")
  errorMessage      String?
  metadata          Json?
  createdAt         DateTime @default(now())

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  baseResume      BaseResume?      @relation(fields: [baseResumeId], references: [id], onDelete: SetNull)
  tailoredVersion TailoredVersion? @relation(fields: [tailoredVersionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([baseResumeId])
  @@index([tailoredVersionId])
  @@index([action])
  @@map("ai_request_logs")
}

model GeneratedDocument {
  id                String           @id @default(cuid())
  userId            String
  baseResumeId      String?
  tailoredVersionId String?
  type              GeneratedDocType @default(COVER_LETTER)
  templateId        String?
  tone              String?
  jobTitle          String?
  company           String?
  data              Json
  storagePath       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  baseResume      BaseResume?      @relation(fields: [baseResumeId], references: [id], onDelete: SetNull)
  tailoredVersion TailoredVersion? @relation(fields: [tailoredVersionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([type])
  @@map("generated_documents")
}

model Resume {
  id     String @id @default(cuid())
  userId String

  // Basic Info
  fileName   String
  templateId String? // Selected template ID

  // Resume Data (stored as JSON)
  // Contains: name, title, email, phone, location, summary, skills, experience, education, projects, certifications
  data Json // Complete resume data structure

  // Section Configuration
  sectionOrder      String[] @default([]) // Order of sections
  sectionVisibility Json     @default("{}") // Which sections are visible
  customSections    Json     @default("[]") // Custom sections added by user
  customFields      Json     @default("[]") // Custom contact fields

  // Formatting Options
  formatting Json @default("{}") // fontFamily, fontSize, lineSpacing, sectionSpacing, margins, headingStyle, bulletStyle

  // Metadata
  isStarred  Boolean @default(false)
  isArchived Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation("Resumes", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([fileName])
  @@index([isStarred])
  @@index([isArchived])
  @@index([createdAt])
  @@map("resumes")
}

model AIDraft {
  id           String   @id @default(cuid())
  userId       String
  baseResumeId String
  action       AIAction
  payload      Json
  metadata     Json?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  baseResume BaseResume @relation(fields: [baseResumeId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([baseResumeId])
  @@index([expiresAt])
  @@map("ai_drafts")
}

// ============================================
// AI AGENT MODELS
// ============================================

model AIAgentTask {
  id     String             @id @default(cuid())
  userId String
  type   AIAgentTaskType
  status AIAgentTaskStatus @default(QUEUED)

  // Progress tracking
  progress      Int     @default(0) // 0-100
  currentStep   String? // Human-readable current step
  totalSteps    Int?    // Total number of steps
  completedStep Int?    // Current step number

  // Job details
  jobTitle       String?
  company        String?
  jobUrl         String?
  jobDescription String? @db.Text

  // Configuration
  baseResumeId String? // Which base resume to use
  tone         String? @default("professional")
  length       String? @default("medium")
  batchId      String? // Correlation ID for bulk operations

  // Results
  resultData   Json? // Generated resume, cover letter, etc.
  atsScore     Int?
  atsBreakdown Json? // Detailed ATS score breakdown
  outputFiles  Json? // Array of generated file paths

  // Error handling
  errorMessage String? @db.Text
  retryCount   Int     @default(0)
  maxRetries   Int     @default(3)

  // Timestamps
  queuedAt    DateTime  @default(now())
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user         User             @relation("AIAgentTasks", fields: [userId], references: [id], onDelete: Cascade)
  applications JobApplication[]

  @@index([userId, status])
  @@index([userId, createdAt])
  @@index([status])
  @@index([type])
  @@index([batchId])
  @@map("ai_agent_tasks")
}

model AIAgentSettings {
  id     String @id @default(cuid())
  userId String @unique

  // Master toggle
  isEnabled Boolean @default(true)

  // Capability toggles
  autoFillEnabled        Boolean @default(true)
  multiResumeEnabled     Boolean @default(true)
  bulkProcessingEnabled  Boolean @default(true)
  jobTrackerEnabled      Boolean @default(true)
  coldEmailEnabled       Boolean @default(false)
  interviewPrepEnabled   Boolean @default(true)
  companyResearchEnabled Boolean @default(true)

  // Preferences
  defaultTone            String @default("professional") // professional, casual, enthusiastic
  defaultLength          String @default("medium") // concise, medium, detailed
  maxConcurrentTasks     Int    @default(3)
  autoAddToJobTracker    Boolean @default(true)
  notifyOnTaskComplete   Boolean @default(true)
  notifyOnTaskFail       Boolean @default(true)

  // Advanced settings
  atsScoreThreshold      Int     @default(80) // Minimum ATS score to accept
  autoRetryFailedTasks   Boolean @default(true)
  saveAllGeneratedResumes Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation("AIAgentSettings", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("ai_agent_settings")
}

model AIAgentHistory {
  id     String @id @default(cuid())
  userId String

  // Task summary
  taskType AIAgentTaskType
  taskIds  String[] @default([]) // IDs of tasks in this batch
  summary  String // "5 resumes generated for different JDs"
  count    Int    @default(1)

  // Metadata
  status      String // "Completed successfully", "Partially failed"
  metadata    Json? // Additional data about the batch
  completedAt DateTime @default(now())

  user User @relation("AIAgentHistory", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, completedAt])
  @@index([taskType])
  @@map("ai_agent_history")
}

model AIAgentConversation {
  id     String @id @default(cuid())
  userId String

  // Messages stored as JSON array
  // [{sender: 'user'|'ai', message: string, timestamp: string, suggestedActions?: []}]
  messages Json @default("[]")

  // Context
  isActive Boolean @default(true)
  context  Json? // Store context like current job, company, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation("AIAgentConversations", fields: [userId], references: [id], onDelete: Cascade)

  // Note: Partial unique index (userId where isActive=true) created in migration
  // to allow only one active conversation per user, but unlimited archived ones
  @@index([userId, isActive])
  @@index([updatedAt])
  @@map("ai_agent_conversations")
}

model AIAgentMetrics {
  id     String @id @default(cuid())
  userId String

  // Daily metrics
  date DateTime @db.Date

  // Task counts
  resumesGenerated     Int @default(0)
  coverLettersCreated  Int @default(0)
  applicationsSubmitted Int @default(0)
  companiesResearched  Int @default(0)
  emailsSent           Int @default(0)
  interviewPrepsCreated Int @default(0)

  // Performance metrics
  tasksCompleted  Int @default(0)
  tasksFailed     Int @default(0)
  averageAtsScore Float?
  totalTimeSpent  Int @default(0) // In seconds

  // AI usage
  aiTokensUsed Int     @default(0)
  aiCostUsd    Decimal @default(0) @db.Decimal(12, 4)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation("AIAgentMetrics", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
  @@map("ai_agent_metrics")
}

model JobBoardSession {
  id       String @id @default(cuid())
  userId   Int
  platform String // linkedin, indeed, etc.

  // Encrypted session data
  sessionData String @db.Text // Encrypted cookies and storage data
  iv          String // Initialization vector for encryption
  authTag     String // Authentication tag for AES-GCM

  // Metadata
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, platform])
  @@index([userId])
  @@index([platform])
  @@index([expiresAt])
  @@map("job_board_sessions")
}

model JobBoardCredential {
  id       String           @id @default(cuid())
  userId   String
  platform JobBoardPlatform

  // Encrypted credentials
  email           String
  encryptedData   String  @db.Text // Encrypted password and other sensitive data
  iv              String // Initialization vector for encryption
  authTag         String // Authentication tag for AES-GCM

  // Metadata
  isActive        Boolean  @default(true)
  lastVerified    DateTime?
  verificationStatus String @default("pending") // pending, verified, failed

  // Connection info
  isConnected     Boolean  @default(false)
  lastConnectedAt DateTime?
  connectionError String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User             @relation("JobBoardCredentials", fields: [userId], references: [id], onDelete: Cascade)
  applications JobApplication[]

  @@unique([userId, platform, email])
  @@index([userId])
  @@index([platform])
  @@index([isActive])
  @@map("job_board_credentials")
}

model JobApplication {
  id                  String             @id @default(cuid())
  userId              String
  credentialId        String?
  aiAgentTaskId       String? // Link to AI Agent task that created it

  // Job details
  jobTitle            String
  company             String
  jobUrl              String?            @db.Text
  jobDescription      String?            @db.Text
  location            String?
  salary              String?
  jobType             String? // Full-time, Part-time, Contract, etc.
  platform            JobBoardPlatform
  externalJobId       String? // Job ID on the platform

  // Application details
  status              ApplicationStatus  @default(DRAFT)
  appliedAt           DateTime?
  lastStatusUpdate    DateTime?

  // Files used
  resumeFileId        String?
  coverLetterFileId   String?

  // Resume/Cover Letter data (for reference)
  resumeData          Json?
  coverLetterData     Json?

  // ATS Score
  atsScore            Int?
  atsBreakdown        Json?

  // Tracking
  isAutoApplied       Boolean  @default(false)
  applicationMethod   String? // easy_apply, quick_apply, external, manual

  // Follow-up
  followUpDate        DateTime?
  followUpNotes       String?  @db.Text

  // Metadata
  notes               String?  @db.Text
  metadata            Json? // Additional platform-specific data

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user              User                        @relation("JobApplications", fields: [userId], references: [id], onDelete: Cascade)
  credential        JobBoardCredential?         @relation(fields: [credentialId], references: [id], onDelete: SetNull)
  aiAgentTask       AIAgentTask?                @relation(fields: [aiAgentTaskId], references: [id], onDelete: SetNull)
  resumeFile        StorageFile?                @relation("ApplicationResume", fields: [resumeFileId], references: [id], onDelete: SetNull)
  coverLetterFile   StorageFile?                @relation("ApplicationCoverLetter", fields: [coverLetterFileId], references: [id], onDelete: SetNull)
  statusHistory     ApplicationStatusHistory[]

  @@index([userId, status])
  @@index([userId, createdAt])
  @@index([status])
  @@index([platform])
  @@index([credentialId])
  @@index([aiAgentTaskId])
  @@index([appliedAt])
  @@map("job_applications")
}

model ApplicationStatusHistory {
  id            String            @id @default(cuid())
  applicationId String

  status        ApplicationStatus
  notes         String?           @db.Text
  metadata      Json? // Additional context about the status change

  createdAt DateTime @default(now())

  application JobApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([createdAt])
  @@map("application_status_history")
}
