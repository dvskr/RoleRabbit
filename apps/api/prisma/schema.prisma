// Prisma schema for RoleReady Database - Normalized for Scale (50M+ users)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTHENTICATION & CORE USER DATA
// ============================================

model User {
  id             String  @id @default(cuid())
  email          String  @unique
  name           String
  password       String? // Optional for OAuth users
  provider       String  @default("local") // local, google, github
  providerId     String? @unique
  
  // Two-Factor Authentication
  twoFactorEnabled     Boolean @default(false)
  twoFactorSecret      String?
  twoFactorBackupCodes String? // JSON array of backup codes
  
  // Preferences (frequently accessed)
  emailNotifications Boolean @default(true)
  smsNotifications   Boolean @default(false)
  privacyLevel       String? @default("Professional")
  profileVisibility  String? @default("Public")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  profile            UserProfile?
  refreshTokens      RefreshToken[]
  sessions           Session[]
  passwordResetTokens PasswordResetToken[]

  @@index([email])
  @@index([provider, providerId])
  @@map("users")
}

// ============================================
// USER PROFILE (One-to-One with User)
// ============================================

model UserProfile {
  id        String @id @default(cuid())
  userId    String @unique
  
  // Basic Information
  firstName      String?
  lastName       String?
  phone          String?
  location       String?
  bio            String?
  profilePicture String?
  
  // Professional Summary
  currentRole    String?
  currentCompany String?
  
  // Social Links
  linkedin       String?
  github         String?
  website        String?
  
  // Profile Analytics & Metrics
  profileViews         Int @default(0)
  profileCompleteness  Int @default(0) // Percentage (0-100)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  workExperiences   WorkExperience[]
  education         Education[]
  certifications    Certification[]
  projects          Project[]
  achievements      Achievement[]
  volunteerExperiences VolunteerExperience[]
  recommendations   Recommendation[]
  publications      Publication[]
  patents           Patent[]
  organizations     Organization[]
  testScores        TestScore[]
  careerGoals       CareerGoal[]
  careerTimeline    CareerTimeline[]
  socialLinks       SocialLink[]
  userSkills        UserSkill[]

  @@index([userId])
  @@map("user_profiles")
}

// ============================================
// WORK EXPERIENCE (One-to-Many with UserProfile)
// ============================================

model WorkExperience {
  id          String   @id @default(cuid())
  profileId   String
  
  company     String
  role        String
  location    String?
  startDate   String
  endDate     String?
  isCurrent   Boolean  @default(false)
  description String?
  projectType String?  @default("Full-time") // Full-time, Part-time, Contract, etc.
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([company])
  @@map("work_experiences")
}

// ============================================
// EDUCATION (One-to-Many with UserProfile)
// ============================================

model Education {
  id             String   @id @default(cuid())
  profileId      String
  
  institution    String
  degree         String?
  field          String?
  graduationDate String?
  description    String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([institution])
  @@map("education")
}

// ============================================
// SKILLS (Many-to-Many with UserProfile)
// ============================================

model Skill {
  id          String   @id @default(cuid())
  name        String   @unique // Normalized skill name
  category    String?  // e.g., "Technical", "Soft", "Language"
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userSkills UserSkill[]

  @@index([name])
  @@index([category])
  @@map("skills")
}

model UserSkill {
  id                String   @id @default(cuid())
  profileId         String
  skillId           String
  
  proficiency       String?  @default("Beginner") // Beginner, Intermediate, Advanced, Expert
  yearsOfExperience Int?
  verified          Boolean  @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  skill   Skill       @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([profileId, skillId])
  @@index([profileId])
  @@index([skillId])
  @@map("user_skills")
}

// ============================================
// CERTIFICATIONS (One-to-Many with UserProfile)
// ============================================

model Certification {
  id          String   @id @default(cuid())
  profileId   String
  
  name        String
  issuer      String?
  date        String?
  expiryDate  String?
  credentialId String?
  credentialUrl String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([issuer])
  @@map("certifications")
}

// ============================================
// PROJECTS (One-to-Many with UserProfile)
// ============================================

model Project {
  id          String   @id @default(cuid())
  profileId   String
  
  title       String
  description String?
  technologies String? // JSON array or comma-separated
  date        String?
  link        String?
  github      String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("projects")
}

// ============================================
// ACHIEVEMENTS (One-to-Many with UserProfile)
// ============================================

model Achievement {
  id          String   @id @default(cuid())
  profileId   String
  
  type        String   // Award, Recognition, Competition, etc.
  title       String
  description String?
  date        String?
  link        String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([type])
  @@map("achievements")
}

// ============================================
// ADDITIONAL PROFILE SECTIONS
// ============================================

model VolunteerExperience {
  id          String   @id @default(cuid())
  profileId   String
  
  organization String
  role         String
  startDate    String
  endDate      String?
  description  String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("volunteer_experiences")
}

model Recommendation {
  id          String   @id @default(cuid())
  profileId   String
  
  recommenderName String
  recommenderRole String?
  recommenderCompany String?
  content      String
  date        String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("recommendations")
}

model Publication {
  id          String   @id @default(cuid())
  profileId   String
  
  title       String
  authors     String?
  publication String?
  date        String?
  link        String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("publications")
}

model Patent {
  id          String   @id @default(cuid())
  profileId   String
  
  title       String
  patentNumber String?
  date        String?
  link        String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("patents")
}

model Organization {
  id          String   @id @default(cuid())
  profileId   String
  
  name        String
  role        String?
  startDate   String?
  endDate     String?
  description String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("organizations")
}

model TestScore {
  id          String   @id @default(cuid())
  profileId   String
  
  testName    String
  score       String?
  date        String?
  description String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("test_scores")
}

model CareerGoal {
  id          String   @id @default(cuid())
  profileId   String
  
  title       String
  description String?
  targetDate  String?
  progress     Int      @default(0) // 0-100
  category    String?  // Role, Company, Location, Skill, Education, Other
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([category])
  @@map("career_goals")
}

model CareerTimeline {
  id          String   @id @default(cuid())
  profileId   String
  
  title       String
  description String?
  date        String?
  type        String?  @default("Work") // Work, Education, Achievement, etc.
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("career_timeline")
}

model SocialLink {
  id          String   @id @default(cuid())
  profileId   String
  
  platform    String   // LinkedIn, GitHub, Twitter, Portfolio, etc.
  url         String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, platform])
  @@index([profileId])
  @@map("social_links")
}

// ============================================
// AUTHENTICATION & SESSION MANAGEMENT
// ============================================

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  device       String? // Device info (desktop, mobile, tablet)
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())
  lastActivity DateTime @default(now())
  expiresAt    DateTime
  isActive     Boolean  @default(true)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
  @@index([expiresAt])
  @@map("sessions")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime
  used      Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}
