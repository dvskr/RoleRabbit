generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SubscriptionTier {
  FREE
  PRO
  PREMIUM
}

enum TailorMode {
  PARTIAL
  FULL
}

enum AIAction {
  GENERATE_CONTENT
  TAILOR_PARTIAL
  TAILOR_FULL
  APPLY_RECOMMENDATIONS
  COVER_LETTER
  PORTFOLIO
  JD_ANALYSIS
  ATS_SCORE
}

enum GeneratedDocType {
  COVER_LETTER
  PORTFOLIO_SECTION
  OTHER
}

model Certification {
  id        String @id @default(cuid())
  profileId String

  name          String
  issuer        String?
  date          String?
  expiryDate    String?
  credentialId  String?
  credentialUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([issuer])
  @@map("certifications")
}

model CredentialReminder {
  id           String   @id @default(cuid())
  credentialId String
  reminderDate DateTime
  isSent       Boolean  @default(false)
  priority     String   @default("medium") // low, medium, high

  createdAt DateTime @default(now())

  credential Credential @relation(fields: [credentialId], references: [id], onDelete: Cascade)

  @@index([credentialId])
  @@index([reminderDate])
  @@index([isSent])
  @@map("credential_reminders")
}

model Credential {
  id     String  @id @default(cuid())
  userId String
  fileId String? // Associated file if any

  credentialType  String // certification, license, visa, degree, badge
  name            String
  issuer          String
  issuedDate      String
  expirationDate  String?
  credentialId    String? // External credential ID
  verificationUrl String?
  qrCode          String? // Base64 QR code

  verificationStatus String @default("pending") // pending, verified, expired, revoked

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User                 @relation("Credentials", fields: [userId], references: [id], onDelete: Cascade)
  file      StorageFile?         @relation(fields: [fileId], references: [id], onDelete: SetNull)
  reminders CredentialReminder[]

  @@index([userId])
  @@index([fileId])
  @@index([credentialType])
  @@index([verificationStatus])
  @@map("credentials")
}

model Education {
  id        String @id @default(cuid())
  profileId String

  institution String
  degree      String?
  field       String?
  startDate   String?
  endDate     String?
  gpa         String?
  honors      String?
  location    String?
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([institution])
  @@map("education")
}

model Language {
  id        String @id @default(cuid())
  profileId String

  name        String
  proficiency String? // Native, Fluent, Conversational, Basic, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("languages")
}

model FileAccessLog {
  id        String  @id @default(cuid())
  fileId    String
  userId    String
  action    String // view, download, share, edit, delete
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  file StorageFile @relation(fields: [fileId], references: [id], onDelete: Cascade)
  user User        @relation("FileAccessLogs", fields: [userId], references: [id], onDelete: Cascade)

  @@index([fileId])
  @@index([userId])
  @@index([createdAt])
  @@map("file_access_logs")
}

model FileComment {
  id       String  @id @default(cuid())
  fileId   String
  userId   String
  content  String
  parentId String? // For threaded comments

  isResolved Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  file    StorageFile   @relation(fields: [fileId], references: [id], onDelete: Cascade)
  user    User          @relation("FileComments", fields: [userId], references: [id], onDelete: Cascade)
  parent  FileComment?  @relation("CommentThread", fields: [parentId], references: [id], onDelete: Cascade)
  replies FileComment[] @relation("CommentThread")

  @@index([fileId])
  @@index([parentId])
  @@map("file_comments")
}

model FileShare {
  id         String @id @default(cuid())
  fileId     String
  userId     String // User who shared
  sharedWith String // User ID of recipient

  permission String    @default("view") // view, comment, edit, admin
  expiresAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  file      StorageFile @relation(fields: [fileId], references: [id], onDelete: Cascade)
  sharer    User        @relation("FileShares", fields: [userId], references: [id], onDelete: Cascade)
  recipient User        @relation("SharedWithMe", fields: [sharedWith], references: [id], onDelete: Cascade)

  @@unique([fileId, sharedWith])
  @@index([fileId])
  @@index([sharedWith])
  @@map("file_shares")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime
  used      Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model Project {
  id        String @id @default(cuid())
  profileId String

  title        String
  description  String?
  technologies String? // JSON array or comma-separated
  date         String?
  link         String?
  github       String?
  media        String? // JSON array of media URLs

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("projects")
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  device       String? // Device info (desktop, mobile, tablet)
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())
  lastActivity DateTime @default(now())
  expiresAt    DateTime
  isActive     Boolean  @default(true)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
  @@index([expiresAt])
  @@map("sessions")
}

model ShareLink {
  id     String @id @default(cuid())
  fileId String
  userId String

  token         String    @unique
  password      String? // Hashed password if protected
  permission    String    @default("view") // view, comment, edit, admin
  expiresAt     DateTime?
  maxDownloads  Int?
  downloadCount Int       @default(0)

  createdAt DateTime @default(now())

  file StorageFile @relation(fields: [fileId], references: [id], onDelete: Cascade)
  user User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([fileId])
  @@map("share_links")
}

model Skill {
  id       String  @id @default(cuid())
  name     String  @unique // Normalized skill name
  category String? // e.g., "Technical", "Soft", "Language"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userSkills UserSkill[]

  @@index([name])
  @@index([category])
  @@map("skills")
}

model StorageFile {
  id     String @id @default(cuid())
  userId String

  // File Information
  name        String // Display name
  fileName    String // Original filename
  type        String // resume, template, backup, document, etc.
  contentType String // MIME type (e.g., application/pdf)
  size        BigInt // File size in bytes
  storagePath String // Path in Supabase Storage or local filesystem
  publicUrl   String? // Public URL if bucket is public

  // Metadata
  description String? // File description
  isPublic    Boolean @default(false)
  isStarred   Boolean @default(false)
  isArchived  Boolean @default(false)
  folderId    String? // Parent folder ID

  // Soft delete
  deletedAt DateTime?

  // File metrics
  downloadCount Int @default(0)
  viewCount     Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user                     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  folder                   StorageFolder?   @relation(fields: [folderId], references: [id], onDelete: SetNull)
  shares                   FileShare[]
  shareLinks               ShareLink[]
  comments                 FileComment[]
  accessLogs               FileAccessLog[]
  credentials              Credential[]

  @@index([userId])
  @@index([folderId])
  @@index([type])
  @@index([deletedAt])
  @@index([isStarred])
  @@index([isArchived])
  @@map("storage_files")
}

model StorageFolder {
  id     String @id @default(cuid())
  userId String

  name     String
  parentId String? // For nested folders
  color    String? // Optional folder color

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent   StorageFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children StorageFolder[] @relation("FolderHierarchy")
  files    StorageFile[]

  @@index([userId])
  @@index([parentId])
  @@index([deletedAt])
  @@map("storage_folders")
}

model StorageQuota {
  id         String @id @default(cuid())
  userId     String @unique
  usedBytes  BigInt @default(0)
  limitBytes BigInt @default(5368709120) // 5GB default

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("storage_quotas")
}

model UserProfile {
  id     String @id @default(cuid())
  userId String @unique

  // Profile Tab - Basic Information
  firstName      String?
  lastName       String?
  phone          String?
  personalEmail  String? // Personal/contact email (separate from login email)
  location       String?
  profilePicture String?

  // Profile Tab - Social Links
  linkedin  String?
  github    String?
  portfolio String? // Portfolio URL
  website   String?

  // Professional Tab
  professionalBio String? @map("professionalBio")

  // Profile Analytics & Metrics
  profileCompleteness Int @default(0) // Percentage (0-100)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations - Only keep what's needed for the tabs
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  workExperiences WorkExperience[] // Professional Tab
  projects        Project[] // Professional Tab - Separate section
  education       Education[] // Skills & Expertise Tab
  certifications  Certification[] // Skills & Expertise Tab
  languages       Language[] // Skills & Expertise Tab
  userSkills      UserSkill[] // Skills & Expertise Tab

  @@index([userId])
  @@map("user_profiles")
}

model UserSkill {
  id        String @id @default(cuid())
  profileId String
  skillId   String

  yearsOfExperience Int?
  verified          Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  skill   Skill       @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([profileId, skillId])
  @@index([profileId])
  @@index([skillId])
  @@map("user_skills")
}

model User {
  id         String  @id @default(cuid())
  email      String  @unique
  name       String
  password   String? // Optional for OAuth users
  provider   String  @default("local") // local, google, github
  providerId String? @unique

  // Two-Factor Authentication
  twoFactorEnabled     Boolean @default(false)
  twoFactorSecret      String?
  twoFactorBackupCodes String? // JSON array of backup codes

  // Preferences (frequently accessed)
  emailNotifications Boolean @default(true)

  // Subscription & Usage Tracking
  subscriptionTier          SubscriptionTier @default(FREE)
  subscriptionEndsAt        DateTime?
  activeBaseResumeId        String?          @unique
  resumeAiUsageCount        Int              @default(0)
  resumeAiUsageResetAt      DateTime?
  coverLetterAiUsageCount   Int              @default(0)
  coverLetterAiUsageResetAt DateTime?
  portfolioPublishesCount   Int              @default(0)
  portfolioPublishesResetAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  profile             UserProfile?
  refreshTokens       RefreshToken[]
  sessions            Session[]
  passwordResetTokens PasswordResetToken[]
  storageFiles        StorageFile[]
  storageFolders      StorageFolder[]
  fileShares          FileShare[]          @relation("FileShares")
  sharedFiles         FileShare[]          @relation("SharedWithMe")
  shareLinks          ShareLink[]
  fileComments        FileComment[]        @relation("FileComments")
  fileAccessLogs      FileAccessLog[]      @relation("FileAccessLogs")
  credentials         Credential[]         @relation("Credentials")
  storageQuota        StorageQuota?
  resumes             Resume[]             @relation("Resumes")
  baseResumes         BaseResume[]         @relation("UserBaseResumes")
  tailoredVersions    TailoredVersion[]
  generatedDocuments  GeneratedDocument[]
  aiRequests          AIRequestLog[]
  aiDrafts            AIDraft[]
  resumeCacheEntries  ResumeCache[]
  activeBaseResume    BaseResume?          @relation("ActiveBaseResume", fields: [activeBaseResumeId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([provider, providerId])
  @@map("users")
}

model WorkExperience {
  id        String @id @default(cuid())
  profileId String

  company      String
  role         String
  location     String?
  startDate    String
  endDate      String?
  isCurrent    Boolean  @default(false)
  description  String?
  technologies String[] @default([]) // Technologies/tools used in this role
  projectType  String?  @default("Full-time") // Full-time, Part-time, Contract, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([company])
  @@map("work_experiences")
}

model BaseResume {
  id                   String    @id @default(cuid())
  userId               String
  slotNumber           Int
  name                 String
  isActive             Boolean   @default(false)
  data                 Json
  formatting           Json?     @default("{}")
  metadata             Json?     @default("{}")
  lastAIAccessedAt     DateTime?
  parsingConfidence    Float?
  embedding            String?   @db.Text // pgvector embedding stored as text
  embeddingUpdatedAt   DateTime? @map("embedding_updated_at")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user               User                @relation("UserBaseResumes", fields: [userId], references: [id], onDelete: Cascade)
  activeUser         User?               @relation("ActiveBaseResume")
  tailoredVersions   TailoredVersion[]
  generatedDocuments GeneratedDocument[]
  resumeCaches       ResumeCache[]
  aiRequests         AIRequestLog[]
  aiDrafts           AIDraft[]

  @@unique([userId, slotNumber])
  @@index([userId, isActive])
  @@map("base_resumes")
}

model TailoredVersion {
  id                 String     @id @default(cuid())
  baseResumeId       String
  userId             String
  jobTitle           String?
  company            String?
  jobDescriptionHash String?
  mode               TailorMode @default(PARTIAL)
  tone               String?
  data               Json
  diff               Json?
  atsScoreBefore     Int?
  atsScoreAfter      Int?
  isPromoted         Boolean    @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  baseResume         BaseResume          @relation(fields: [baseResumeId], references: [id], onDelete: Cascade)
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  generatedDocuments GeneratedDocument[]
  aiRequests         AIRequestLog[]

  @@index([baseResumeId])
  @@index([userId])
  @@index([jobDescriptionHash])
  @@map("tailored_versions")
}

model ResumeCache {
  id           String    @id @default(cuid())
  userId       String
  baseResumeId String?
  fileHash     String    @unique
  method       String
  data         Json
  confidence   Float?
  hitCount     Int       @default(0)
  createdAt    DateTime  @default(now())
  lastUsedAt   DateTime  @default(now())
  expiresAt    DateTime?

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  baseResume BaseResume? @relation(fields: [baseResumeId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@map("resume_cache")
}

model AIRequestLog {
  id                String   @id @default(cuid())
  userId            String
  baseResumeId      String?
  tailoredVersionId String?
  action            AIAction
  provider          String?
  model             String?
  tokensUsed        Int?
  costUsd           Decimal? @db.Decimal(12, 4)
  status            String   @default("success")
  errorMessage      String?
  metadata          Json?
  createdAt         DateTime @default(now())

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  baseResume      BaseResume?      @relation(fields: [baseResumeId], references: [id], onDelete: SetNull)
  tailoredVersion TailoredVersion? @relation(fields: [tailoredVersionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([baseResumeId])
  @@index([tailoredVersionId])
  @@index([action])
  @@map("ai_request_logs")
}

model GeneratedDocument {
  id                String           @id @default(cuid())
  userId            String
  baseResumeId      String?
  tailoredVersionId String?
  type              GeneratedDocType @default(COVER_LETTER)
  templateId        String?
  tone              String?
  jobTitle          String?
  company           String?
  data              Json
  storagePath       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  baseResume      BaseResume?      @relation(fields: [baseResumeId], references: [id], onDelete: SetNull)
  tailoredVersion TailoredVersion? @relation(fields: [tailoredVersionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([type])
  @@map("generated_documents")
}

model Resume {
  id     String @id @default(cuid())
  userId String

  // Basic Info
  fileName   String
  templateId String? // Selected template ID

  // Resume Data (stored as JSON)
  // Contains: name, title, email, phone, location, summary, skills, experience, education, projects, certifications
  data Json // Complete resume data structure

  // Section Configuration
  sectionOrder      String[] @default([]) // Order of sections
  sectionVisibility Json     @default("{}") // Which sections are visible
  customSections    Json     @default("[]") // Custom sections added by user
  customFields      Json     @default("[]") // Custom contact fields

  // Formatting Options
  formatting Json @default("{}") // fontFamily, fontSize, lineSpacing, sectionSpacing, margins, headingStyle, bulletStyle

  // Metadata
  isStarred  Boolean @default(false)
  isArchived Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation("Resumes", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([fileName])
  @@index([isStarred])
  @@index([isArchived])
  @@index([createdAt])
  @@map("resumes")
}

model AIDraft {
  id           String   @id @default(cuid())
  userId       String
  baseResumeId String
  action       AIAction
  payload      Json
  metadata     Json?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  baseResume BaseResume @relation(fields: [baseResumeId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([baseResumeId])
  @@index([expiresAt])
  @@map("ai_drafts")
}
