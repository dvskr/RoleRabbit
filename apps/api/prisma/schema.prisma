generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SubscriptionTier {
  FREE
  PRO
  PREMIUM
}

enum TailorMode {
  PARTIAL
  FULL
}

enum AIAction {
  GENERATE_CONTENT
  TAILOR_PARTIAL
  TAILOR_FULL
  APPLY_RECOMMENDATIONS
  COVER_LETTER
  PORTFOLIO
  JD_ANALYSIS
  ATS_SCORE
}

enum GeneratedDocType {
  COVER_LETTER
  PORTFOLIO_SECTION
  OTHER
}

enum JobStatus {
  APPLIED
  INTERVIEW
  OFFER
  REJECTED
}

enum JobPriority {
  LOW
  MEDIUM
  HIGH
}

model Certification {
  id        String @id @default(cuid())
  profileId String

  name          String
  issuer        String?
  date          String?
  expiryDate    String?
  credentialId  String?
  credentialUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([issuer])
  @@map("certifications")
}

model CredentialReminder {
  id           String   @id @default(cuid())
  credentialId String
  reminderDate DateTime
  isSent       Boolean  @default(false)
  priority     String   @default("medium") // low, medium, high

  createdAt DateTime @default(now())

  credential Credential @relation(fields: [credentialId], references: [id], onDelete: Cascade)

  @@index([credentialId])
  @@index([reminderDate])
  @@index([isSent])
  @@map("credential_reminders")
}

model Credential {
  id     String  @id @default(cuid())
  userId String
  fileId String? // Associated file if any

  credentialType  String // certification, license, visa, degree, badge
  name            String
  issuer          String
  issuedDate      String
  expirationDate  String?
  credentialId    String? // External credential ID
  verificationUrl String?
  qrCode          String? // Base64 QR code

  verificationStatus String @default("pending") // pending, verified, expired, revoked

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User                 @relation("Credentials", fields: [userId], references: [id], onDelete: Cascade)
  file      StorageFile?         @relation(fields: [fileId], references: [id], onDelete: SetNull)
  reminders CredentialReminder[]

  @@index([userId])
  @@index([fileId])
  @@index([credentialType])
  @@index([verificationStatus])
  @@map("credentials")
}

model Education {
  id        String @id @default(cuid())
  profileId String

  institution String
  degree      String?
  field       String?
  startDate   String?
  endDate     String?
  gpa         String?
  honors      String?
  location    String?
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([institution])
  @@map("education")
}

model Language {
  id        String @id @default(cuid())
  profileId String

  name        String
  proficiency String? // Native, Fluent, Conversational, Basic, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("languages")
}

model FileAccessLog {
  id        String  @id @default(cuid())
  fileId    String
  userId    String
  action    String // view, download, share, edit, delete
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  file StorageFile @relation(fields: [fileId], references: [id], onDelete: Cascade)
  user User        @relation("FileAccessLogs", fields: [userId], references: [id], onDelete: Cascade)

  @@index([fileId])
  @@index([userId])
  @@index([createdAt])
  @@map("file_access_logs")
}

model FileComment {
  id       String  @id @default(cuid())
  fileId   String
  userId   String
  content  String
  parentId String? // For threaded comments

  isResolved Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  file    StorageFile   @relation(fields: [fileId], references: [id], onDelete: Cascade)
  user    User          @relation("FileComments", fields: [userId], references: [id], onDelete: Cascade)
  parent  FileComment?  @relation("CommentThread", fields: [parentId], references: [id], onDelete: Cascade)
  replies FileComment[] @relation("CommentThread")

  @@index([fileId])
  @@index([parentId])
  @@map("file_comments")
}

model FileShare {
  id         String @id @default(cuid())
  fileId     String
  userId     String // User who shared
  sharedWith String // User ID of recipient

  permission String    @default("view") // view, comment, edit, admin
  expiresAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  file      StorageFile @relation(fields: [fileId], references: [id], onDelete: Cascade)
  sharer    User        @relation("FileShares", fields: [userId], references: [id], onDelete: Cascade)
  recipient User        @relation("SharedWithMe", fields: [sharedWith], references: [id], onDelete: Cascade)

  @@unique([fileId, sharedWith])
  @@index([fileId])
  @@index([sharedWith])
  @@map("file_shares")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime
  used      Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model Project {
  id        String @id @default(cuid())
  profileId String

  title        String
  description  String?
  technologies String? // JSON array or comma-separated
  date         String?
  link         String?
  github       String?
  media        String? // JSON array of media URLs

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("projects")
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  device       String? // Device info (desktop, mobile, tablet)
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())
  lastActivity DateTime @default(now())
  expiresAt    DateTime
  isActive     Boolean  @default(true)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
  @@index([expiresAt])
  @@map("sessions")
}

model ShareLink {
  id     String @id @default(cuid())
  fileId String
  userId String

  token         String    @unique
  password      String? // Hashed password if protected
  permission    String    @default("view") // view, comment, edit, admin
  expiresAt     DateTime?
  maxDownloads  Int?
  downloadCount Int       @default(0)

  createdAt DateTime @default(now())

  file StorageFile @relation(fields: [fileId], references: [id], onDelete: Cascade)
  user User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([fileId])
  @@map("share_links")
}

model Skill {
  id       String  @id @default(cuid())
  name     String  @unique // Normalized skill name
  category String? // e.g., "Technical", "Soft", "Language"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userSkills UserSkill[]

  @@index([name])
  @@index([category])
  @@map("skills")
}

model StorageFile {
  id     String @id @default(cuid())
  userId String

  // File Information
  name        String // Display name
  fileName    String // Original filename
  type        String // resume, template, backup, document, etc.
  contentType String // MIME type (e.g., application/pdf)
  size        BigInt // File size in bytes
  storagePath String // Path in Supabase Storage or local filesystem
  publicUrl   String? // Public URL if bucket is public
  fileHash    String? // SHA-256 hash of file content for change detection

  // Metadata
  description String? // File description
  isPublic    Boolean @default(false)
  isStarred   Boolean @default(false)
  isArchived  Boolean @default(false)
  folderId    String? // Parent folder ID

  // Soft delete
  deletedAt DateTime?

  // File metrics
  downloadCount Int @default(0)
  viewCount     Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user                     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  folder                   StorageFolder?   @relation(fields: [folderId], references: [id], onDelete: SetNull)
  shares                   FileShare[]
  shareLinks               ShareLink[]
  comments                 FileComment[]
  accessLogs               FileAccessLog[]
  credentials              Credential[]
  baseResumes              BaseResume[]
  jobAttachments           JobAttachment[]  @relation("JobAttachments")

  @@index([userId])
  @@index([folderId])
  @@index([type])
  @@index([deletedAt])
  @@index([isStarred])
  @@index([isArchived])
  @@index([fileHash])
  @@map("storage_files")
}

model StorageFolder {
  id     String @id @default(cuid())
  userId String

  name     String
  parentId String? // For nested folders
  color    String? // Optional folder color

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent   StorageFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children StorageFolder[] @relation("FolderHierarchy")
  files    StorageFile[]

  @@index([userId])
  @@index([parentId])
  @@index([deletedAt])
  @@map("storage_folders")
}

model StorageQuota {
  id         String @id @default(cuid())
  userId     String @unique
  usedBytes  BigInt @default(0)
  limitBytes BigInt @default(5368709120) // 5GB default

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("storage_quotas")
}

model UserProfile {
  id     String @id @default(cuid())
  userId String @unique

  // Profile Tab - Basic Information
  firstName      String?
  lastName       String?
  phone          String?
  personalEmail  String? // Personal/contact email (separate from login email)
  location       String?
  profilePicture String?

  // Profile Tab - Social Links
  linkedin  String?
  github    String?
  portfolio String? // Portfolio URL
  website   String?

  // Professional Tab
  professionalBio String? @map("professionalBio")

  // Profile Analytics & Metrics
  profileCompleteness Int @default(0) // Percentage (0-100)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations - Only keep what's needed for the tabs
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  workExperiences WorkExperience[] // Professional Tab
  projects        Project[] // Professional Tab - Separate section
  education       Education[] // Skills & Expertise Tab
  certifications  Certification[] // Skills & Expertise Tab
  languages       Language[] // Skills & Expertise Tab
  userSkills      UserSkill[] // Skills & Expertise Tab

  @@index([userId])
  @@map("user_profiles")
}

model UserSkill {
  id        String @id @default(cuid())
  profileId String
  skillId   String

  yearsOfExperience Int?
  verified          Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  skill   Skill       @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([profileId, skillId])
  @@index([profileId])
  @@index([skillId])
  @@map("user_skills")
}

model User {
  id         String  @id @default(cuid())
  email      String  @unique
  name       String
  password   String? // Optional for OAuth users
  provider   String  @default("local") // local, google, github
  providerId String? @unique

  // Two-Factor Authentication
  twoFactorEnabled     Boolean @default(false)
  twoFactorSecret      String?
  twoFactorBackupCodes String? // JSON array of backup codes

  // Preferences (frequently accessed)
  emailNotifications Boolean @default(true)

  // Tailoring Preferences
  tailorPreferredMode   TailorMode? @default(PARTIAL)
  tailorPreferredTone   String?     @default("professional")
  tailorPreferredLength String?     @default("thorough")

  // Subscription & Usage Tracking
  subscriptionTier          SubscriptionTier @default(FREE)
  subscriptionEndsAt        DateTime?
  activeBaseResumeId        String?          @unique
  resumeAiUsageCount        Int              @default(0)
  resumeAiUsageResetAt      DateTime?
  coverLetterAiUsageCount   Int              @default(0)
  coverLetterAiUsageResetAt DateTime?
  portfolioPublishesCount   Int              @default(0)
  portfolioPublishesResetAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  profile             UserProfile?
  refreshTokens       RefreshToken[]
  sessions            Session[]
  passwordResetTokens PasswordResetToken[]
  storageFiles        StorageFile[]
  storageFolders      StorageFolder[]
  fileShares          FileShare[]          @relation("FileShares")
  sharedFiles         FileShare[]          @relation("SharedWithMe")
  shareLinks          ShareLink[]
  fileComments        FileComment[]        @relation("FileComments")
  fileAccessLogs      FileAccessLog[]      @relation("FileAccessLogs")
  credentials         Credential[]         @relation("Credentials")
  storageQuota        StorageQuota?
  resumes             Resume[]             @relation("Resumes")
  baseResumes         BaseResume[]         @relation("UserBaseResumes")
  tailoredVersions    TailoredVersion[]
  generatedDocuments  GeneratedDocument[]
  aiRequests          AIRequestLog[]
  aiDrafts            AIDraft[]
  resumeCacheEntries  ResumeCache[]
  tailoringAnalytics  TailoringAnalytics[]
  analyticsEvents     AnalyticsEvent[]     @relation("AnalyticsEvents")
  webhookConfig       WebhookConfig?       @relation("WebhookConfig")
  webhookLogs         WebhookLog[]         @relation("WebhookLogs")
  promptTests         PromptTest[]         @relation("PromptTests")
  activeBaseResume    BaseResume?          @relation("ActiveBaseResume", fields: [activeBaseResumeId], references: [id], onDelete: SetNull)
  jobs                Job[]                @relation("UserJobs")
  interviewNotes      InterviewNote[]      @relation("UserInterviewNotes")
  salaryOffers        SalaryOffer[]        @relation("UserSalaryOffers")
  companyInsights     CompanyInsight[]     @relation("UserCompanyInsights")
  referralContacts    ReferralContact[]    @relation("UserReferralContacts")
  jobNotes            JobNote[]            @relation("UserJobNotes")
  jobReminders        JobReminder[]        @relation("UserJobReminders")
  savedViews          SavedView[]          @relation("UserSavedViews")
  jobAttachments      JobAttachment[]      @relation("UserJobAttachments")

  @@index([email])
  @@index([provider, providerId])
  @@map("users")
}

model WorkExperience {
  id        String @id @default(cuid())
  profileId String

  company      String
  role         String
  location     String?
  startDate    String
  endDate      String?
  isCurrent    Boolean  @default(false)
  description  String?
  technologies String[] @default([]) // Technologies/tools used in this role
  projectType  String?  @default("Full-time") // Full-time, Part-time, Contract, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([company])
  @@map("work_experiences")
}

model BaseResume {
  id                 String    @id @default(cuid())
  userId             String
  slotNumber         Int
  name               String
  isActive           Boolean   @default(false)
  data               Json
  formatting         Json?     @default("{}")
  metadata           Json?     @default("{}")
  lastAIAccessedAt   DateTime?
  parsingConfidence  Float?
  embedding          String?   @db.Text // pgvector embedding stored as text
  embeddingUpdatedAt DateTime? @map("embedding_updated_at")
  storageFileId      String? // Link to uploaded file for parsing
  fileHash           String? // SHA-256 hash for cache lookup

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user               User                 @relation("UserBaseResumes", fields: [userId], references: [id], onDelete: Cascade)
  activeUser         User?                @relation("ActiveBaseResume")
  storageFile        StorageFile?         @relation(fields: [storageFileId], references: [id], onDelete: SetNull)
  workingDraft       WorkingDraft? // One-to-one relation with working draft
  tailoredVersions   TailoredVersion[]
  generatedDocuments GeneratedDocument[]
  resumeCaches       ResumeCache[]
  aiRequests         AIRequestLog[]
  aiDrafts           AIDraft[]
  tailoringAnalytics TailoringAnalytics[]

  @@unique([userId, slotNumber])
  @@index([userId, isActive]) // For finding active resume per user
  @@index([userId, updatedAt]) // For sorting user's resumes by last modified
  @@index([storageFileId])
  @@index([fileHash]) // For cache lookup during parsing
  @@map("base_resumes")
}

model WorkingDraft {
  id           String @id @default(cuid())
  baseResumeId String @unique
  data         Json // Current edits (not yet committed to base)
  formatting   Json?  @default("{}")
  metadata     Json?  @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  baseResume BaseResume @relation(fields: [baseResumeId], references: [id], onDelete: Cascade)

  @@index([baseResumeId])
  @@map("working_drafts")
}

model TailoredVersion {
  id                 String     @id @default(cuid())
  baseResumeId       String
  userId             String
  jobTitle           String?
  company            String?
  jobDescriptionHash String?
  mode               TailorMode @default(PARTIAL)
  tone               String?
  data               Json
  diff               Json?
  atsScoreBefore     Int?
  atsScoreAfter      Int?
  isPromoted         Boolean    @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  baseResume         BaseResume          @relation(fields: [baseResumeId], references: [id], onDelete: Cascade)
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  generatedDocuments GeneratedDocument[]
  aiRequests         AIRequestLog[]

  @@index([baseResumeId])
  @@index([userId])
  @@index([jobDescriptionHash])
  @@index([userId, createdAt]) // For fetching user's recent tailored versions
  @@index([baseResumeId, createdAt]) // For fetching recent versions of a resume
  @@map("tailored_versions")
}

model ResumeCache {
  id           String    @id @default(cuid())
  userId       String
  baseResumeId String?
  fileHash     String    @unique
  method       String
  data         Json
  confidence   Float?
  hitCount     Int       @default(0)
  createdAt    DateTime  @default(now())
  lastUsedAt   DateTime  @default(now())
  expiresAt    DateTime?

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  baseResume BaseResume? @relation(fields: [baseResumeId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@map("resume_cache")
}

model AIRequestLog {
  id                String   @id @default(cuid())
  userId            String
  baseResumeId      String?
  tailoredVersionId String?
  action            AIAction
  provider          String?
  model             String?
  tokensUsed        Int?
  costUsd           Decimal? @db.Decimal(12, 4)
  status            String   @default("success")
  errorMessage      String?
  metadata          Json?
  createdAt         DateTime @default(now())

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  baseResume      BaseResume?      @relation(fields: [baseResumeId], references: [id], onDelete: SetNull)
  tailoredVersion TailoredVersion? @relation(fields: [tailoredVersionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([baseResumeId])
  @@index([tailoredVersionId])
  @@index([action])
  @@index([userId, createdAt]) // For fetching user's recent AI requests
  @@index([action, createdAt]) // For analytics by action type over time
  @@index([userId, action, createdAt]) // For user's requests by action type
  @@map("ai_request_logs")
}

model GeneratedDocument {
  id                String           @id @default(cuid())
  userId            String
  baseResumeId      String?
  tailoredVersionId String?
  type              GeneratedDocType @default(COVER_LETTER)
  templateId        String?
  tone              String?
  jobTitle          String?
  company           String?
  data              Json
  storagePath       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  baseResume      BaseResume?      @relation(fields: [baseResumeId], references: [id], onDelete: SetNull)
  tailoredVersion TailoredVersion? @relation(fields: [tailoredVersionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([type])
  @@map("generated_documents")
}

model Resume {
  id     String @id @default(cuid())
  userId String

  // Basic Info
  fileName   String
  templateId String? // Selected template ID

  // Resume Data (stored as JSON)
  // Contains: name, title, email, phone, location, summary, skills, experience, education, projects, certifications
  data Json // Complete resume data structure

  // Section Configuration
  sectionOrder      String[] @default([]) // Order of sections
  sectionVisibility Json     @default("{}") // Which sections are visible
  customSections    Json     @default("[]") // Custom sections added by user
  customFields      Json     @default("[]") // Custom contact fields

  // Formatting Options
  formatting Json @default("{}") // fontFamily, fontSize, lineSpacing, sectionSpacing, margins, headingStyle, bulletStyle

  // Metadata
  isStarred  Boolean @default(false)
  isArchived Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation("Resumes", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([fileName])
  @@index([isStarred])
  @@index([isArchived])
  @@index([createdAt])
  @@map("resumes")
}

model AIDraft {
  id           String   @id @default(cuid())
  userId       String
  baseResumeId String
  action       AIAction
  payload      Json
  metadata     Json?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  baseResume BaseResume @relation(fields: [baseResumeId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([baseResumeId])
  @@index([expiresAt])
  @@map("ai_drafts")
}

model TailoringAnalytics {
  id                 String   @id @default(cuid())
  userId             String
  resumeId           String
  mode               String
  scoreBefore        Float
  scoreAfter         Float
  improvement        Float
  improvementRate    Float
  targetScore        Float
  targetMet          Boolean
  tokensUsed         Int?
  durationMs         Int
  confidence         Float    @default(0)
  warningCount       Int      @default(0)
  changeCount        Int      @default(0)
  keywordsAddedCount Int      @default(0)
  costEstimate       Float    @default(0)
  timestamp          DateTime @default(now())
  createdAt          DateTime @default(now())

  user   User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  resume BaseResume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([timestamp])
  @@index([mode])
  @@index([userId, timestamp])
  @@map("tailoring_analytics")
}

// ============================================================
// Job Tracker Models
// ============================================================

model Job {
  id     String @id @default(cuid())
  userId String

  // Basic Information
  title    String
  company  String
  location String
  status   JobStatus    @default(APPLIED)
  priority JobPriority? @default(MEDIUM)

  // Application Details
  appliedDate   String // Date in YYYY-MM-DD format
  salary        String? // Salary range or amount
  description   String? @db.Text
  url           String? // Job posting URL
  notes         String? @db.Text
  nextStep      String?
  nextStepDate  String? // Date in YYYY-MM-DD format

  // Contact Information (JSON)
  contact Json? // {name, email, phone}

  // Additional Details
  requirements String[] @default([])
  benefits     String[] @default([])
  remote       Boolean  @default(false)
  companySize  String?
  industry     String?

  // Metadata
  isFavorite Boolean   @default(false)
  deletedAt  DateTime? // Soft delete

  createdAt   DateTime @default(now())
  lastUpdated DateTime @updatedAt

  // Relations
  user            User              @relation("UserJobs", fields: [userId], references: [id], onDelete: Cascade)
  interviewNotes  InterviewNote[]
  salaryOffers    SalaryOffer[]
  companyInsights CompanyInsight[]
  referrals       ReferralContact[]
  jobNotes        JobNote[]
  reminders       JobReminder[]
  attachments     JobAttachment[]

  @@index([userId])
  @@index([status])
  @@index([priority])
  @@index([company])
  @@index([appliedDate])
  @@index([deletedAt])
  @@index([isFavorite])
  @@map("jobs")
}

model InterviewNote {
  id    String @id @default(cuid())
  jobId String
  userId String

  type        String // phone, technical, behavioral, final, other
  date        String // Date in YYYY-MM-DD format
  interviewer String?
  notes       String  @db.Text
  questions   String[] @default([])
  feedback    String?  @db.Text
  rating      Int? // 1-5 rating

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  job  Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user User @relation("UserInterviewNotes", fields: [userId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([userId])
  @@index([date])
  @@map("interview_notes")
}

model SalaryOffer {
  id    String @id @default(cuid())
  jobId String
  userId String

  amount   Float
  currency String  @default("USD")
  equity   String? // Stock options, RSUs, etc.
  benefits String[] @default([])
  notes    String?  @db.Text
  date     String // Date in YYYY-MM-DD format
  status   String  @default("initial") // initial, countered, accepted, rejected

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  job  Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user User @relation("UserSalaryOffers", fields: [userId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([userId])
  @@index([status])
  @@map("salary_offers")
}

model CompanyInsight {
  id    String @id @default(cuid())
  jobId String
  userId String

  type    String // culture, benefits, growth, reviews, news, other
  title   String
  content String @db.Text
  source  String?
  date    String // Date in YYYY-MM-DD format

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  job  Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user User @relation("UserCompanyInsights", fields: [userId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([userId])
  @@index([type])
  @@map("company_insights")
}

model ReferralContact {
  id    String @id @default(cuid())
  jobId String
  userId String

  name         String
  position     String
  relationship String
  contacted    Boolean @default(false)
  date         String // Date in YYYY-MM-DD format
  notes        String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  job  Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user User @relation("UserReferralContacts", fields: [userId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([userId])
  @@index([contacted])
  @@map("referral_contacts")
}

model JobNote {
  id    String @id @default(cuid())
  jobId String
  userId String

  title    String
  content  String   @db.Text
  tags     String[] @default([])
  date     String // Date in YYYY-MM-DD format
  category String   @default("other") // research, application, interview, offer, other

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  job  Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user User @relation("UserJobNotes", fields: [userId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([userId])
  @@index([category])
  @@map("job_notes")
}

model JobReminder {
  id    String @id @default(cuid())
  jobId String
  userId String

  title       String
  description String  @db.Text
  dueDate     String // Date in YYYY-MM-DD format
  completed   Boolean     @default(false)
  priority    JobPriority @default(MEDIUM)
  type        String      @default("other") // follow-up, deadline, interview, application, other

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  job  Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user User @relation("UserJobReminders", fields: [userId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([userId])
  @@index([dueDate])
  @@index([completed])
  @@map("job_reminders")
}

model SavedView {
  id     String @id @default(cuid())
  userId String

  name    String
  filters Json // JobFilters as JSON
  columns String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation("UserSavedViews", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("saved_views")
}

model JobAttachment {
  id        String @id @default(cuid())
  jobId     String
  userId    String
  fileId    String
  attachmentType String @default("other") // resume, cover_letter, portfolio, other

  createdAt DateTime @default(now())

  job  Job         @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user User        @relation("UserJobAttachments", fields: [userId], references: [id], onDelete: Cascade)
  file StorageFile @relation("JobAttachments", fields: [fileId], references: [id], onDelete: Cascade)

  @@unique([jobId, fileId]) // Prevent duplicate attachments
  @@index([jobId])
  @@index([userId])
  @@index([fileId])
  @@map("job_attachments")
}

model AnalyticsEvent {
  id         String   @id @default(cuid())
  userId     String
  event      String   // Event name (e.g., 'resume_uploaded', 'ats_check_success')
  properties String   @default("{}") // JSON string of event properties
  sessionId  String?  // Optional session identifier
  timestamp  DateTime @default(now())
  createdAt  DateTime @default(now())

  user User @relation("AnalyticsEvents", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([event])
  @@index([timestamp])
  @@index([userId, timestamp])
  @@index([event, timestamp])
  @@map("analytics_events")
}

model WebhookConfig {
  id            String   @id @default(cuid())
  userId        String   @unique
  url           String   // Webhook endpoint URL
  secret        String   // HMAC secret for signature verification
  enabled       Boolean  @default(true)
  enabledEvents String   @default("[]") // JSON array of enabled event types
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation("WebhookConfig", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([enabled])
  @@map("webhook_configs")
}

model WebhookLog {
  id          String    @id @default(cuid())
  userId      String
  event       String    // Event type
  url         String    // Webhook URL that was called
  payload     String    // JSON payload sent
  success     Boolean   // Whether delivery was successful
  statusCode  Int?      // HTTP status code received
  attempts    Int       @default(1) // Number of delivery attempts
  error       String?   // Error message if failed
  deliveryId  String    @unique // Unique delivery identifier
  deliveredAt DateTime? // When successfully delivered
  createdAt   DateTime  @default(now())

  user User @relation("WebhookLogs", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([event])
  @@index([success])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([deliveryId])
  @@map("webhook_logs")
}

model PromptVariant {
  id          String   @id @default(cuid())
  name        String   // Descriptive name (e.g., "Tailoring Prompt v2")
  operation   String   // Operation type (e.g., "tailoring", "ats_analysis", "content_generation")
  variant     String   // Variant identifier (e.g., "A", "B", "control")
  prompt      String   @db.Text // The actual prompt text
  metadata    String   @default("{}") // JSON metadata (compression settings, etc.)
  isActive    Boolean  @default(true)
  isControl   Boolean  @default(false) // Whether this is the control variant
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tests PromptTest[]

  @@unique([operation, variant])
  @@index([operation])
  @@index([isActive])
  @@map("prompt_variants")
}

model PromptTest {
  id             String   @id @default(cuid())
  userId         String
  variantId      String
  operation      String   // Operation type
  variant        String   // Variant identifier
  inputHash      String   // Hash of input data (for grouping similar tests)
  success        Boolean  // Whether operation succeeded
  durationMs     Int      // Operation duration
  tokensUsed     Int?     // Tokens consumed
  costUsd        Float?   // Cost in USD
  qualityScore   Float?   // Quality score (0-100)
  userRating     Int?     // User rating (1-5 stars)
  outputMetrics  String   @default("{}") // JSON metrics (ATS score, keyword count, etc.)
  error          String?  // Error message if failed
  createdAt      DateTime @default(now())

  user           User          @relation("PromptTests", fields: [userId], references: [id], onDelete: Cascade)
  promptVariant  PromptVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([variantId])
  @@index([operation])
  @@index([variant])
  @@index([userId])
  @@index([createdAt])
  @@index([operation, variant, createdAt])
  @@map("prompt_tests")
}
