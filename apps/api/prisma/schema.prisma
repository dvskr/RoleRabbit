generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SubscriptionTier {
  FREE
  PRO
  PREMIUM
}

enum TailorMode {
  PARTIAL
  FULL
}

enum AIAction {
  GENERATE_CONTENT
  TAILOR_PARTIAL
  TAILOR_FULL
  APPLY_RECOMMENDATIONS
  COVER_LETTER
  PORTFOLIO
  JD_ANALYSIS
  ATS_SCORE
}

enum GeneratedDocType {
  COVER_LETTER
  PORTFOLIO_SECTION
  OTHER
}

enum TemplateCategory {
  ATS
  CREATIVE
  MODERN
  CLASSIC
  EXECUTIVE
  MINIMAL
  ACADEMIC
  TECHNICAL
  STARTUP
  FREELANCE
}

enum TemplateDifficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum TemplateLayout {
  SINGLE_COLUMN
  TWO_COLUMN
  HYBRID
}

enum TemplateColorScheme {
  MONOCHROME
  BLUE
  GREEN
  PURPLE
  RED
  ORANGE
  CUSTOM
}

enum TemplateUsageAction {
  PREVIEW
  DOWNLOAD
  USE
  FAVORITE
  SHARE
}

model Certification {
  id        String @id @default(cuid())
  profileId String

  name          String
  issuer        String?
  date          String?
  expiryDate    String?
  credentialId  String?
  credentialUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([issuer])
  @@map("certifications")
}

model CredentialReminder {
  id           String   @id @default(cuid())
  credentialId String
  reminderDate DateTime
  isSent       Boolean  @default(false)
  priority     String   @default("medium") // low, medium, high

  createdAt DateTime @default(now())

  credential Credential @relation(fields: [credentialId], references: [id], onDelete: Cascade)

  @@index([credentialId])
  @@index([reminderDate])
  @@index([isSent])
  @@map("credential_reminders")
}

model Credential {
  id     String  @id @default(cuid())
  userId String
  fileId String? // Associated file if any

  credentialType  String // certification, license, visa, degree, badge
  name            String
  issuer          String
  issuedDate      String
  expirationDate  String?
  credentialId    String? // External credential ID
  verificationUrl String?
  qrCode          String? // Base64 QR code

  verificationStatus String @default("pending") // pending, verified, expired, revoked

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User                 @relation("Credentials", fields: [userId], references: [id], onDelete: Cascade)
  file      StorageFile?         @relation(fields: [fileId], references: [id], onDelete: SetNull)
  reminders CredentialReminder[]

  @@index([userId])
  @@index([fileId])
  @@index([credentialType])
  @@index([verificationStatus])
  @@map("credentials")
}

model Education {
  id        String @id @default(cuid())
  profileId String

  institution String
  degree      String?
  field       String?
  startDate   String?
  endDate     String?
  gpa         String?
  honors      String?
  location    String?
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([institution])
  @@map("education")
}

model Language {
  id        String @id @default(cuid())
  profileId String

  name        String
  proficiency String? // Native, Fluent, Conversational, Basic, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("languages")
}

model FileAccessLog {
  id        String  @id @default(cuid())
  fileId    String
  userId    String
  action    String // view, download, share, edit, delete
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  file StorageFile @relation(fields: [fileId], references: [id], onDelete: Cascade)
  user User        @relation("FileAccessLogs", fields: [userId], references: [id], onDelete: Cascade)

  @@index([fileId])
  @@index([userId])
  @@index([createdAt])
  // Composite indexes for access log queries
  @@index([fileId, createdAt])
  @@index([userId, createdAt])
  @@index([fileId, userId])
  @@map("file_access_logs")
}

model FileComment {
  id       String  @id @default(cuid())
  fileId   String
  userId   String
  content  String
  parentId String? // For threaded comments

  isResolved Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  file    StorageFile   @relation(fields: [fileId], references: [id], onDelete: Cascade)
  user    User          @relation("FileComments", fields: [userId], references: [id], onDelete: Cascade)
  parent  FileComment?  @relation("CommentThread", fields: [parentId], references: [id], onDelete: Cascade)
  replies FileComment[] @relation("CommentThread")

  @@index([fileId])
  @@index([parentId])
  @@map("file_comments")
}

model FileShare {
  id         String @id @default(cuid())
  fileId     String
  userId     String // User who shared
  sharedWith String // User ID of recipient

  permission String    @default("view") // view, comment, edit, admin
  expiresAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  file      StorageFile @relation(fields: [fileId], references: [id], onDelete: Cascade)
  sharer    User        @relation("FileShares", fields: [userId], references: [id], onDelete: Cascade)
  recipient User        @relation("SharedWithMe", fields: [sharedWith], references: [id], onDelete: Cascade)

  @@unique([fileId, sharedWith])
  @@index([fileId])
  @@index([sharedWith])
  @@map("file_shares")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime
  used      Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model Project {
  id        String @id @default(cuid())
  profileId String

  title        String
  description  String?
  technologies String? // JSON array or comma-separated
  date         String?
  link         String?
  github       String?
  media        String? // JSON array of media URLs

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("projects")
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  device       String? // Device info (desktop, mobile, tablet)
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())
  lastActivity DateTime @default(now())
  expiresAt    DateTime
  isActive     Boolean  @default(true)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
  @@index([expiresAt])
  @@map("sessions")
}

model ShareLink {
  id     String @id @default(cuid())
  fileId String
  userId String

  token         String    @unique
  password      String? // Hashed password if protected
  permission    String    @default("view") // view, comment, edit, admin
  expiresAt     DateTime?
  maxDownloads  Int?
  downloadCount Int       @default(0)

  createdAt DateTime @default(now())

  file StorageFile @relation(fields: [fileId], references: [id], onDelete: Cascade)
  user User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([fileId])
  @@map("share_links")
}

model FileVersion {
  id       String @id @default(cuid())
  fileId   String
  userId   String
  versionNumber Int // Version number (1, 2, 3, etc.)

  // File Information (snapshot at time of version)
  fileName    String
  contentType String
  size        BigInt
  storagePath String // Path to versioned file
  fileHash    String // SHA-256 hash for integrity

  // Version metadata
  changeDescription String? // What changed in this version
  isActive          Boolean @default(false) // Only one active version per file

  createdAt DateTime @default(now())

  file StorageFile @relation("FileVersions", fields: [fileId], references: [id], onDelete: Cascade)
  user User        @relation("FileVersions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([fileId, versionNumber])
  @@index([fileId])
  @@index([userId])
  @@index([isActive])
  @@map("file_versions")
}

model FileTag {
  id     String  @id @default(cuid())
  userId String? // If null, it's a system tag

  name  String
  color String? // Hex color code for UI

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User?         @relation("UserFileTags", fields: [userId], references: [id], onDelete: Cascade)
  files FileTagging[]

  @@unique([userId, name]) // User can't have duplicate tag names
  @@index([userId])
  @@index([name])
  @@map("file_tags")
}

model FileTagging {
  id     String @id @default(cuid())
  fileId String
  tagId  String

  createdAt DateTime @default(now())

  file StorageFile @relation("FileTagging", fields: [fileId], references: [id], onDelete: Cascade)
  tag  FileTag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([fileId, tagId]) // Can't tag same file with same tag twice
  @@index([fileId])
  @@index([tagId])
  @@map("file_tagging")
}

model Skill {
  id       String  @id @default(cuid())
  name     String  @unique // Normalized skill name
  category String? // e.g., "Technical", "Soft", "Language"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userSkills UserSkill[]

  @@index([name])
  @@index([category])
  @@map("skills")
}

model StorageFile {
  id     String @id @default(cuid())
  userId String

  // File Information
  name        String // Display name
  fileName    String // Original filename
  type        String // resume, template, backup, document, etc.
  contentType String // MIME type (e.g., application/pdf)
  size        BigInt // File size in bytes
  storagePath String // Path in Supabase Storage or local filesystem
  publicUrl   String? // Public URL if bucket is public
  fileHash    String? // SHA-256 hash of file content for change detection

  // Metadata
  description String? // File description
  isPublic    Boolean @default(false)
  isStarred   Boolean @default(false)
  isArchived  Boolean @default(false)
  folderId    String? // Parent folder ID

  // Soft delete
  deletedAt DateTime?

  // File metrics
  downloadCount Int @default(0)
  viewCount     Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user                     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  folder                   StorageFolder?   @relation(fields: [folderId], references: [id], onDelete: SetNull)
  shares                   FileShare[]
  shareLinks               ShareLink[]
  comments                 FileComment[]
  accessLogs               FileAccessLog[]
  credentials              Credential[]
  baseResumes              BaseResume[]
  jobAttachments           JobAttachment[]  @relation("JobAttachments")
  versions                 FileVersion[]    @relation("FileVersions")
  tags                     FileTagging[]    @relation("FileTagging")

  @@index([userId])
  @@index([folderId])
  @@index([type])
  @@index([deletedAt])
  @@index([isStarred])
  @@index([isArchived])
  @@index([fileHash])
  @@index([createdAt])
  // Composite indexes for common query patterns
  @@index([userId, deletedAt])
  @@index([userId, type])
  @@index([userId, folderId])
  @@index([userId, isStarred])
  @@index([userId, isArchived])
  @@index([userId, createdAt])
  @@map("storage_files")
}

model StorageFolder {
  id     String @id @default(cuid())
  userId String

  name     String
  parentId String? // For nested folders
  color    String? // Optional folder color

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent   StorageFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children StorageFolder[] @relation("FolderHierarchy")
  files    StorageFile[]

  @@index([userId])
  @@index([parentId])
  @@index([deletedAt])
  @@map("storage_folders")
}

model StorageQuota {
  id         String @id @default(cuid())
  userId     String @unique
  usedBytes  BigInt @default(0)
  limitBytes BigInt @default(5368709120) // 5GB default

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("storage_quotas")
}

model UserProfile {
  id     String @id @default(cuid())
  userId String @unique

  // Profile Tab - Basic Information
  firstName      String?
  lastName       String?
  phone          String?
  personalEmail  String? // Personal/contact email (separate from login email)
  location       String?
  profilePicture String?

  // Profile Tab - Social Links
  linkedin  String?
  github    String?
  portfolio String? // Portfolio URL
  website   String?

  // Professional Tab
  professionalBio String? @map("professionalBio")

  // Profile Analytics & Metrics
  profileCompleteness Int @default(0) // Percentage (0-100)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations - Only keep what's needed for the tabs
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  workExperiences WorkExperience[] // Professional Tab
  projects        Project[] // Professional Tab - Separate section
  education       Education[] // Skills & Expertise Tab
  certifications  Certification[] // Skills & Expertise Tab
  languages       Language[] // Skills & Expertise Tab
  userSkills      UserSkill[] // Skills & Expertise Tab

  @@index([userId])
  @@map("user_profiles")
}

model UserSkill {
  id        String @id @default(cuid())
  profileId String
  skillId   String

  yearsOfExperience Int?
  verified          Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  skill   Skill       @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([profileId, skillId])
  @@index([profileId])
  @@index([skillId])
  @@map("user_skills")
}

model User {
  id         String  @id @default(cuid())
  email      String  @unique
  name       String
  password   String? // Optional for OAuth users
  provider   String  @default("local") // local, google, github
  providerId String? @unique

  // Two-Factor Authentication
  twoFactorEnabled     Boolean @default(false)
  twoFactorSecret      String?
  twoFactorBackupCodes String? // JSON array of backup codes

  // Preferences (frequently accessed)
  emailNotifications Boolean @default(true)

  // Tailoring Preferences
  tailorPreferredMode   TailorMode? @default(PARTIAL)
  tailorPreferredTone   String?     @default("professional")
  tailorPreferredLength String?     @default("thorough")

  // Subscription & Usage Tracking
  subscriptionTier          SubscriptionTier @default(FREE)
  subscriptionEndsAt        DateTime?
  activeBaseResumeId        String?          @unique
  resumeAiUsageCount        Int              @default(0)
  resumeAiUsageResetAt      DateTime?
  coverLetterAiUsageCount   Int              @default(0)
  coverLetterAiUsageResetAt DateTime?
  portfolioPublishesCount   Int              @default(0)
  portfolioPublishesResetAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  profile             UserProfile?
  refreshTokens       RefreshToken[]
  sessions            Session[]
  passwordResetTokens PasswordResetToken[]
  storageFiles        StorageFile[]
  storageFolders      StorageFolder[]
  fileShares          FileShare[]          @relation("FileShares")
  sharedFiles         FileShare[]          @relation("SharedWithMe")
  shareLinks          ShareLink[]
  fileComments        FileComment[]        @relation("FileComments")
  fileAccessLogs      FileAccessLog[]      @relation("FileAccessLogs")
  credentials         Credential[]         @relation("Credentials")
  fileVersions        FileVersion[]        @relation("FileVersions")
  fileTags            FileTag[]            @relation("UserFileTags")
  storageQuota        StorageQuota?
  resumes             Resume[]             @relation("Resumes")
  baseResumes         BaseResume[]         @relation("UserBaseResumes")
  tailoredVersions    TailoredVersion[]
  generatedDocuments  GeneratedDocument[]
  aiRequests          AIRequestLog[]
  aiDrafts            AIDraft[]
  resumeCacheEntries    ResumeCache[]
  tailoringAnalytics    TailoringAnalytics[]
  activeBaseResume      BaseResume?                @relation("ActiveBaseResume", fields: [activeBaseResumeId], references: [id], onDelete: SetNull)
  templateFavorites     UserTemplateFavorite[]     @relation("UserTemplateFavorites")
  templatePreferences   UserTemplatePreferences?   @relation("UserTemplatePreferences")
  templateUsageHistory  TemplateUsageHistory[]     @relation("UserTemplateHistory")

  @@index([email])
  @@index([provider, providerId])
  @@map("users")
}

model WorkExperience {
  id        String @id @default(cuid())
  profileId String

  company      String
  role         String
  location     String?
  startDate    String
  endDate      String?
  isCurrent    Boolean  @default(false)
  description  String?
  technologies String[] @default([]) // Technologies/tools used in this role
  projectType  String?  @default("Full-time") // Full-time, Part-time, Contract, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([company])
  @@map("work_experiences")
}

model BaseResume {
  id                 String    @id @default(cuid())
  userId             String
  slotNumber         Int
  name               String
  isActive           Boolean   @default(false)
  data               Json
  formatting         Json?     @default("{}")
  metadata           Json?     @default("{}")
  lastAIAccessedAt   DateTime?
  parsingConfidence  Float?
  embedding          String?   @db.Text // pgvector embedding stored as text
  embeddingUpdatedAt DateTime? @map("embedding_updated_at")
  storageFileId      String? // Link to uploaded file for parsing
  fileHash           String? // SHA-256 hash for cache lookup

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user               User                 @relation("UserBaseResumes", fields: [userId], references: [id], onDelete: Cascade)
  activeUser         User?                @relation("ActiveBaseResume")
  storageFile        StorageFile?         @relation(fields: [storageFileId], references: [id], onDelete: SetNull)
  workingDraft       WorkingDraft? // One-to-one relation with working draft
  tailoredVersions   TailoredVersion[]
  generatedDocuments GeneratedDocument[]
  resumeCaches       ResumeCache[]
  aiRequests         AIRequestLog[]
  aiDrafts           AIDraft[]
  tailoringAnalytics TailoringAnalytics[]

  @@unique([userId, slotNumber])
  @@index([userId, isActive]) // For finding active resume per user
  @@index([userId, updatedAt]) // For sorting user's resumes by last modified
  @@index([storageFileId])
  @@index([fileHash]) // For cache lookup during parsing
  @@map("base_resumes")
}

model WorkingDraft {
  id           String @id @default(cuid())
  baseResumeId String @unique
  data         Json // Current edits (not yet committed to base)
  formatting   Json?  @default("{}")
  metadata     Json?  @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  baseResume BaseResume @relation(fields: [baseResumeId], references: [id], onDelete: Cascade)

  @@index([baseResumeId])
  @@map("working_drafts")
}

model TailoredVersion {
  id                 String     @id @default(cuid())
  baseResumeId       String
  userId             String
  jobTitle           String?
  company            String?
  jobDescriptionHash String?
  mode               TailorMode @default(PARTIAL)
  tone               String?
  data               Json
  diff               Json?
  atsScoreBefore     Int?
  atsScoreAfter      Int?
  isPromoted         Boolean    @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  baseResume         BaseResume          @relation(fields: [baseResumeId], references: [id], onDelete: Cascade)
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  generatedDocuments GeneratedDocument[]
  aiRequests         AIRequestLog[]

  @@index([baseResumeId])
  @@index([userId])
  @@index([jobDescriptionHash])
  @@index([userId, createdAt]) // For fetching user's recent tailored versions
  @@index([baseResumeId, createdAt]) // For fetching recent versions of a resume
  @@map("tailored_versions")
}

model ResumeCache {
  id           String    @id @default(cuid())
  userId       String
  baseResumeId String?
  fileHash     String    @unique
  method       String
  data         Json
  confidence   Float?
  hitCount     Int       @default(0)
  createdAt    DateTime  @default(now())
  lastUsedAt   DateTime  @default(now())
  expiresAt    DateTime?

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  baseResume BaseResume? @relation(fields: [baseResumeId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@map("resume_cache")
}

model AIRequestLog {
  id                String   @id @default(cuid())
  userId            String
  baseResumeId      String?
  tailoredVersionId String?
  action            AIAction
  provider          String?
  model             String?
  tokensUsed        Int?
  costUsd           Decimal? @db.Decimal(12, 4)
  status            String   @default("success")
  errorMessage      String?
  metadata          Json?
  createdAt         DateTime @default(now())

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  baseResume      BaseResume?      @relation(fields: [baseResumeId], references: [id], onDelete: SetNull)
  tailoredVersion TailoredVersion? @relation(fields: [tailoredVersionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([baseResumeId])
  @@index([tailoredVersionId])
  @@index([action])
  @@index([userId, createdAt]) // For fetching user's recent AI requests
  @@index([action, createdAt]) // For analytics by action type over time
  @@index([userId, action, createdAt]) // For user's requests by action type
  @@map("ai_request_logs")
}

model GeneratedDocument {
  id                String           @id @default(cuid())
  userId            String
  baseResumeId      String?
  tailoredVersionId String?
  type              GeneratedDocType @default(COVER_LETTER)
  templateId        String?
  tone              String?
  jobTitle          String?
  company           String?
  data              Json
  storagePath       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  baseResume      BaseResume?      @relation(fields: [baseResumeId], references: [id], onDelete: SetNull)
  tailoredVersion TailoredVersion? @relation(fields: [tailoredVersionId], references: [id], onDelete: SetNull)
  template        ResumeTemplate?  @relation("TemplateGeneratedDocs", fields: [templateId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([type])
  @@index([templateId])
  @@map("generated_documents")
}

model Resume {
  id     String @id @default(cuid())
  userId String

  // Basic Info
  fileName   String
  templateId String? // Selected template ID

  // Resume Data (stored as JSON)
  // Contains: name, title, email, phone, location, summary, skills, experience, education, projects, certifications
  data Json // Complete resume data structure

  // Section Configuration
  sectionOrder      String[] @default([]) // Order of sections
  sectionVisibility Json     @default("{}") // Which sections are visible
  customSections    Json     @default("[]") // Custom sections added by user
  customFields      Json     @default("[]") // Custom contact fields

  // Formatting Options
  formatting Json @default("{}") // fontFamily, fontSize, lineSpacing, sectionSpacing, margins, headingStyle, bulletStyle

  // Metadata
  isStarred  Boolean @default(false)
  isArchived Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation("Resumes", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([fileName])
  @@index([isStarred])
  @@index([isArchived])
  @@index([createdAt])
  @@map("resumes")
}

model AIDraft {
  id           String   @id @default(cuid())
  userId       String
  baseResumeId String
  action       AIAction
  payload      Json
  metadata     Json?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  baseResume BaseResume @relation(fields: [baseResumeId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([baseResumeId])
  @@index([expiresAt])
  @@map("ai_drafts")
}

model TailoringAnalytics {
  id                 String   @id @default(cuid())
  userId             String
  resumeId           String
  mode               String
  scoreBefore        Float
  scoreAfter         Float
  improvement        Float
  improvementRate    Float
  targetScore        Float
  targetMet          Boolean
  tokensUsed         Int?
  durationMs         Int
  confidence         Float    @default(0)
  warningCount       Int      @default(0)
  changeCount        Int      @default(0)
  keywordsAddedCount Int      @default(0)
  costEstimate       Float    @default(0)
  timestamp          DateTime @default(now())
  createdAt          DateTime @default(now())

  user   User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  resume BaseResume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([timestamp])
  @@index([mode])
  @@index([userId, timestamp])
  @@map("tailoring_analytics")
}

model ResumeTemplate {
  id          String              @id @default(cuid())
  name        String
  category    TemplateCategory
  description String              @db.Text
  preview     String // URL or path to preview image
  features    String[] // Array of feature strings
  difficulty  TemplateDifficulty
  industry    String[] // Industries this template is suitable for
  layout      TemplateLayout
  colorScheme TemplateColorScheme
  isPremium   Boolean             @default(false)
  rating      Float               @default(0) @db.DoublePrecision
  downloads   Int                 @default(0)
  author      String              @default("RoleReady Team")
  tags        String[] // Searchable tags

  // Template content and configuration
  templateData Json? // Template structure/configuration
  isActive     Boolean  @default(true) // Can be disabled by admin
  isApproved   Boolean  @default(true) // For user-submitted templates

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  favorites      UserTemplateFavorite[]
  usageHistory   TemplateUsageHistory[]
  generatedDocs  GeneratedDocument[]    @relation("TemplateGeneratedDocs")
  ratings        TemplateRating[]       @relation("TemplateRatings")
  comments       TemplateComment[]      @relation("TemplateComments")
  shares         TemplateShare[]        @relation("TemplateShares")
  versions       TemplateVersion[]      @relation("TemplateVersions")
  approvalWorkflow TemplateApprovalWorkflow[] @relation("TemplateApproval")

  @@index([category])
  @@index([difficulty])
  @@index([isPremium])
  @@index([isActive])
  @@index([rating])
  @@index([downloads])
  @@map("resume_templates")
}

model UserTemplateFavorite {
  id         String   @id @default(cuid())
  userId     String
  templateId String
  createdAt  DateTime @default(now())

  user     User           @relation("UserTemplateFavorites", fields: [userId], references: [id], onDelete: Cascade)
  template ResumeTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([userId, templateId])
  @@index([userId])
  @@index([templateId])
  @@map("user_template_favorites")
}

model UserTemplatePreferences {
  id             String   @id @default(cuid())
  userId         String   @unique
  filterSettings Json     @default("{}") // Saved filter preferences
  sortPreference String   @default("popular") // popular, newest, rating, downloads
  viewMode       String   @default("grid") // grid, list
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation("UserTemplatePreferences", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_template_preferences")
}

model TemplateUsageHistory {
  id         String                @id @default(cuid())
  userId     String
  templateId String
  action     TemplateUsageAction
  metadata   Json? // Additional context (e.g., job title, company)
  createdAt  DateTime              @default(now())

  user     User           @relation("UserTemplateHistory", fields: [userId], references: [id], onDelete: Cascade)
  template ResumeTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([templateId])
  @@index([action])
  @@index([userId, createdAt])
  @@index([templateId, createdAt])
  @@map("template_usage_history")
}

// Advanced Template Features Models

model TemplateRating {
  id         String   @id @default(cuid())
  templateId String
  userId     String
  rating     Int // 1-5
  review     String?  @db.Text
  title      String?
  pros       String?  @db.Text
  cons       String?  @db.Text
  wouldRecommend Boolean @default(true)
  isVerified Boolean @default(false)
  helpfulCount Int @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  template ResumeTemplate @relation("TemplateRatings", fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, userId])
  @@index([templateId])
  @@index([userId])
  @@index([rating])
  @@index([createdAt])
  @@map("template_ratings")
}

model TemplateComment {
  id         String   @id @default(cuid())
  templateId String
  userId     String
  content    String   @db.Text
  parentId   String? // For nested comments
  mentions   String[] @default([]) // User IDs mentioned
  likeCount  Int @default(0)
  replyCount Int @default(0)
  isEdited   Boolean @default(false)
  isHidden   Boolean @default(false)
  editHistory Json? // Array of previous versions
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  template ResumeTemplate @relation("TemplateComments", fields: [templateId], references: [id], onDelete: Cascade)
  parent   TemplateComment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  TemplateComment[] @relation("CommentReplies")

  @@index([templateId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
  @@map("template_comments")
}

model TemplateShare {
  id         String    @id @default(cuid())
  templateId String
  userId     String // Owner/sharer
  shareToken String    @unique
  permission String    @default("VIEW") // VIEW, DOWNLOAD, EDIT, FULL
  expiresAt  DateTime?
  maxUses    Int?
  useCount   Int       @default(0)
  sharedWith String[] @default([]) // Array of user IDs
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  template ResumeTemplate @relation("TemplateShares", fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([userId])
  @@index([shareToken])
  @@index([expiresAt])
  @@map("template_shares")
}

model TemplateVersion {
  id         String   @id @default(cuid())
  templateId String
  versionNumber String // Semantic versioning (e.g., "1.2.3")
  changes    String   @db.Text
  changesHash String // Hash of template data for diff
  snapshot   Json // Complete template data snapshot
  createdBy  String
  createdAt  DateTime @default(now())

  template ResumeTemplate @relation("TemplateVersions", fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([versionNumber])
  @@index([createdAt])
  @@map("template_versions")
}

model TemplateApprovalWorkflow {
  id         String   @id @default(cuid())
  templateId String
  submittedBy String
  reviewedBy String?
  status     String   @default("SUBMITTED") // SUBMITTED, IN_REVIEW, APPROVED, REJECTED, CHANGES_REQUESTED
  submissionNotes String? @db.Text
  reviewNotes String? @db.Text
  qualityScore Float? // Automated quality check score
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  template ResumeTemplate @relation("TemplateApproval", fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([submittedBy])
  @@index([reviewedBy])
  @@index([status])
  @@map("template_approval_workflows")
}

model FilterPreset {
  id      String @id @default(cuid())
  userId  String
  name    String
  filters Json // Saved filter criteria
  sort    Json // Saved sort preferences
  isDefault Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("filter_presets")
}

model ABTest {
  id          String    @id @default(cuid())
  name        String
  description String?   @db.Text
  status      String    @default("DRAFT") // DRAFT, RUNNING, PAUSED, COMPLETED
  startDate   DateTime?
  endDate     DateTime?
  metrics     String[]  @default([]) // Metrics to track
  createdBy   String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  variants    ABTestVariant[]
  assignments ABTestAssignment[]

  @@index([status])
  @@index([createdBy])
  @@map("ab_tests")
}

model ABTestVariant {
  id            String @id @default(cuid())
  testId        String
  name          String
  description   String? @db.Text
  templateId    String?
  config        Json // Variant configuration
  trafficPercent Float @default(50) // Percentage of traffic
  createdAt     DateTime @default(now())

  test        ABTest @relation(fields: [testId], references: [id], onDelete: Cascade)
  assignments ABTestAssignment[]

  @@index([testId])
  @@map("ab_test_variants")
}

model ABTestAssignment {
  id        String   @id @default(cuid())
  testId    String
  variantId String
  userId    String?
  sessionId String?
  events    Json     @default("[]") // Array of tracked events
  createdAt DateTime @default(now())

  test    ABTest        @relation(fields: [testId], references: [id], onDelete: Cascade)
  variant ABTestVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([testId])
  @@index([variantId])
  @@index([userId])
  @@index([sessionId])
  @@map("ab_test_assignments")
}
